name: Build target directory
author: Data Intuitive
description: >
  Builds a target directory using the viash ns build command.

inputs:
  target_branch:
    description: 'Branch to deploy to. If not specified, `${BRANCH_NAME}_build` will be used.'
    required: false
  version:
    description: 'Version name to use for the build. If not specified, `${BRANCH_NAME}_build` will be used.'
    required: false

outputs:
  target_branch:
    description: 'The branch that the build was deployed to.'
    value: ${{ steps.defaults.outputs.target_branch }}
  version:
    description: 'The version that was used for the build.'
    value: ${{ steps.defaults.outputs.version }}
  docker_component_matrix:
    description: Matrix of Docker components
    value: ${{ steps.ns_list_docker.outputs.output_matrix }}
  component_matrix:
    description: Matrix of components
    value: ${{ steps.ns_list.outputs.output_matrix }}

runs:
  using: 'composite'
  steps:
    - name: Determine version tag from branch name
      shell: bash
      id: defaults
      run: |
        BRANCH_NAME=$(echo $GITHUB_REF | sed 's/refs\/heads\///' | sed 's/[^a-zA-Z0-9_]/_/g')
        VERSION=${{ inputs.version }}
        if [ -z "$VERSION" ]; then
          VERSION="${BRANCH_NAME}_build"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        TARGET_BRANCH=${{ inputs.target_branch }}
        if [ -z "$TARGET_BRANCH" ]; then
          TARGET_BRANCH="${BRANCH_NAME}_build"
        fi
        echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT

    - name: Remove target folder from .gitignore
      shell: bash
      run: |
        # allow publishing the target folder
        sed -i '/^\/?target.*/d' .gitignore

    - name: Set version in _viash.yaml
      shell: bash
      run: |
        jq '.version = "${{ steps.defaults.outputs.version }}"' _viash.yaml > _viash.yaml.tmp && \
          mv _viash.yaml.tmp _viash.yaml

    - uses: ../../ns-build
      with:
        parallel: true

    - name: List Docker components
      id: ns_list_docker
      uses: ../../ns-list
      with:
        engine: docker
        format: json

    - name: List components
      id: ns_list
      uses: ../../ns-list
      with:
        format: json